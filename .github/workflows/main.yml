version: 2.1

orbs:
  node: circleci/node@5.1.0
  docker: circleci/docker@2.2.1

jobs:
  install-deps:
    docker:
      - image: cimg/node:18
    steps:
      - checkout
      - run: npm install

  vulnerability-scan:
    docker:
      - image: cimg/node:18
    steps:
      - checkout
      - run: npm install --ignore-scripts
      - run: npm audit --audit-level=moderate

  sonar-scan:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: SonarQube Scan
          command: |
            sonar-scanner \
              -Dsonar.projectKey=YOUR_PROJECT_KEY \
              -Dsonar.sources=./src \
              -Dsonar.host.url=$SONAR_HOST_URL \
              -Dsonar.login=$SONAR_TOKEN

  unit-tests:
    docker:
      - image: cimg/node:18
    steps:
      - checkout
      - run: npm install
      - run: npm test

  lint:
    docker:
      - image: cimg/node:18
    steps:
      - checkout
      - run: npm install
      - run: npx eslint .

  integration-tests:
    docker:
      - image: cimg/node:18
    steps:
      - checkout
      - run: npm install
      - run: npm run test:integration || echo "Integration tests placeholder"

  docker-build-push:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run: docker build -t your-docker-user/your-app-name .
      - run: echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
      - run: docker push your-docker-user/your-app-name

  deploy-to-render:
    docker:
      - image: curlimages/curl:latest
    steps:
      - run:
          name: Deploy to Render
          command: |
            curl -X POST \
              -H "Authorization: Bearer YOUR_RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              --data '{"clearCache": false}' \
              https://api.render.com/v1/services/YOUR_RENDER_SERVICE_ID/deploys

workflows:
  build-test-deploy:
    jobs:
      - install-deps
      - vulnerability-scan:
          requires:
            - install-deps
      - sonar-scan:
          requires:
            - install-deps
      - lint:
          requires:
            - install-deps
      - unit-tests:
          requires:
            - install-deps
      - integration-tests:
          requires:
            - unit-tests
      - docker-build-push:
          requires:
            - integration-tests
      - deploy-to-render:
          requires:
            - docker-build-push
